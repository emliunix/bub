# Development Journal

## Session: 2026-02-16 - MiniMax API Integration Debugging

### Overview
Debugged and fixed MiniMax API integration issues for the Bub agent, tracing through the entire stack from API client to tape storage. Identified and fixed multiple issues including critical bugs in tape recording and conversation sequence handling.

---

## Issues Discovered and Fixed

### Issue 1: Empty Role Error (MiniMax)
**Error**: `invalid role: (2013)`

**Root Cause**: MiniMax API rejects messages with empty or null `role` fields. Some tool result messages were being created without explicit roles.

**Fix Location**: `src/bub/integrations/republic_client.py`

**Key Discovery**: MiniMax accepts standard OpenAI format with `role: "tool"`, contrary to documentation suggesting custom format required.

---

### Issue 2: Critical Bug - Tool Call Data Loss in Tape Server
**Symptom**: Tool calls returned correctly but stored on tape with empty `calls: []`

**Root Cause**: Wrong payload key name in tape server entry conversion

**Location**: `src/bub/tape/server.py:276`

**Buggy Code**:
```python
elif kind == "tool_call":
    return TapeEntry.tool_call(payload.get("tool_calls", []))  # WRONG KEY
```

**Fixed Code**:
```python
elif kind == "tool_call":
    return TapeEntry.tool_call(payload.get("calls", []))  # CORRECT KEY
```

**Impact**: This bug affected ALL tool calls stored via remote tape server, not just MiniMax.

---

### Issue 3: MiniMax "Tool Call Result Does Not Follow Tool Call" Error
**Error**: `invalid params, tool call result does not follow tool call (2013)`

**Root Cause**: When using `tool_calls()` method (not `run_tools()`), the tape stored incomplete conversation sequences:
1. User message
2. Assistant message with `tool_calls`
3. Empty `tool_result` entry (no actual execution)

MiniMax requires the complete sequence: `user → assistant (with tool_calls) → tool → user`

**Fix 1**: Don't record empty tool_result entries
**Location**: `upstream/republic/src/republic/tape/manager.py:104`

**Before**:
```python
if tool_results is not None:
    self._tape_store.append(tape, TapeEntry.tool_result(tool_results, **meta))
```

**After**:
```python
if tool_results:
    self._tape_store.append(tape, TapeEntry.tool_result(tool_results, **meta))
```

**Fix 2**: Don't record incomplete tool call sequences in `tool_calls()` method
**Location**: `upstream/republic/src/republic/clients/chat.py:691-710`

**Rationale**: The `tool_calls()` method only retrieves tool call requests from the model but doesn't execute them. Recording these to tape creates broken conversation sequences. The tape should only record completed interactions (use `run_tools()` for that).

---

### Issue 4: Bus Local Handler Notification Bug
**Symptom**: Local handlers not receiving messages when remote peers connected

**Fix Location**: `src/bub/channels/wsbus.py`

**Implementation**: Fixed handler notification logic to always notify local handlers regardless of remote peer count. Added `_notify_local_handlers` to handle local handlers on server side.

---

### Issue 5: Bus Handler Exception Handling
**Symptom**: Exceptions in handlers weren't being caught properly

**Fix Location**: `src/bub/channels/wsbus.py`

**Implementation**: Fixed `_handle_notification` to catch exceptions during handler execution (not just creation). Added `_run_handler_with_error_handling` wrapper.

---

### Issue 6: Telegram Outbound Subscription
**Symptom**: Telegram adapter wasn't receiving outbound messages from bus

**Fix Location**: `src/bub/channels/telegram.py`

**Implementation**: Added `on_notification("outbound:*", self._handle_outbound_from_bus)` to receive outbound messages and `_handle_outbound_from_bus` handler to send responses back to Telegram.

---

### Issue 7: RPC Protocol Cleanup
**Change**: Removed `publishInbound` and `publishOutbound` RPC methods

**Fix Location**: `src/bub/rpc/protocol.py`

**Implementation**: Kept only `sendMessage` as per original design. Added `send_message` to `AgentBusClientApi`. Updated `src/bub/channels/wsbus.py` to use `sendMessage` with appropriate topics (`inbound:{chat_id}`, `outbound:{chat_id}`).

---

### Issue 8: Tape Context Anchor Setting
**Symptom**: Anchor context not properly maintained during tape operations

**Fix Location**: `src/bub/tape/context.py`

**Changes**: Fixed anchor setting and added debug logging for context tracking. Also fixed edge case in `_build_tool_result_message()` where `tool_call_id` was missing when more results than calls existed.

---

## Architecture Decisions

### Standard Format Adoption
**Principle**: Save Standard, Call by Adapting

```
Tape Storage (Standard Format - OpenAI-compatible)
        ↓
Message Reconstruction (Standard Format)
        ↓
Provider Adapter (Standard → Provider-specific)
        ↓
LLM API Call
```

**Benefits**:
1. Tape always uses consistent format
2. Easy to add new providers (just create adapter)
3. Clear separation of concerns
4. Validation can happen at boundaries

**Implementation**:
- Created `src/bub/llm/format.py` - Standard message format definitions
- Created `src/bub/llm/adapters.py` - Provider adapter framework
- OpenAI format established as the standard internal format

### Message Sequence Requirements
Different LLM providers have different requirements for tool call message sequences:

**MiniMax Requires**:
```
user: "What's the weather?"
assistant: {"tool_calls": [{"function": {"name": "get_weather"}}]}
tool: {"role": "tool", "tool_call_id": "...", "content": "Sunny"}
user: "Next question..."
```

**Broken Sequence (what we had)**:
```
user: "What's the weather?"
assistant: {"tool_calls": [{"function": {"name": "get_weather"}}]}
user: "Next question..."  ← Missing tool message!
```

### API Method Behaviors

**`tool_calls()` vs `run_tools()`**:
- `tool_calls()` - Queries model for tool calls, **does NOT execute tools**, **does NOT record to tape** (after fix)
- `run_tools()` - Executes tools, **records complete conversation** to tape

**Why the distinction matters**:
- `tool_calls()` is for inspection/debugging - you get the tool calls but handle execution yourself
- `run_tools()` is for full automation - tools are executed and results sent back to model

---

## Testing Approach

Created comprehensive test scripts in `scripts/`:

### 1. Direct API Testing
- `test_minimax_tools.py` - Direct OpenAI SDK tests
- `test_minimax_format.py` - Response format inspection

### 2. Republic Integration Testing  
- `test_republic_minimax.py` - Test through Republic client
- `test_bub_minimax_flow.py` - Full Bub stack integration
- `test_minimal_republic_minimax.py` - Minimal reproducible test for Republic + MiniMax

### 3. Storage Debugging
- `test_tape_tool_calls.py` - Debug tape recording
- `test_debug_messages.py` - Deep dive into message reconstruction

### 4. Bus Testing
- `test_bus_client.py` - WebSocket bus client simulation

### 5. Integration Testing
- `test_bub_integration.py` - Full Bub integration layer tests

---

## Deployment Infrastructure

### Production Deploy Script
**File**: `scripts/deploy-production.sh`

**Changes**:
- Converted from systemd-run blocking to `--no-block` for hands-off operation
- Added proper `uv run --env-file` to handle dependencies and .env
- Commands: `start|stop|logs|status|list` for each component (bus, agent, tape)
- Unit names saved to `./run/<component>.unit_name`

**Usage**:
```bash
./scripts/deploy-production.sh start bus      # Start message bus
./scripts/deploy-production.sh start agent    # Start agent worker
./scripts/deploy-production.sh start tape     # Start tape service
./scripts/deploy-production.sh logs agent     # Follow agent logs
./scripts/deploy-production.sh status tape    # Check tape service status
```

---

## Key Discoveries

1. **MiniMax OpenAI Compatibility**: MiniMax accepts standard OpenAI format with `role: "tool"` - contrary to docs suggesting custom format needed
2. **tool_call_id is Required**: Missing `tool_call_id` in tool messages causes "tool call result does not follow tool call" error
3. **Conversation Sequence Integrity**: LLM providers are strict about message sequence completeness
4. **Method Intent Matters**: Similar method names (`tool_calls` vs `run_tools`) have very different behaviors

---

## Verification Steps

1. ✅ **Direct OpenAI SDK**: Confirmed MiniMax works with standard OpenAI format
2. ✅ **Republic Client**: Verified tool_calls() returns correct data
3. ✅ **Minimal Test**: `test_minimal_republic_minimax.py` confirms Republic + MiniMax works
4. ✅ **Integration Test**: `test_bub_integration.py` shows both methods now work
5. ✅ **Multi-turn Test**: Multiple consecutive tool calls work correctly
6. ✅ **Tape Recording**: Complete conversations stored correctly with `run_tools()`

---

## Lessons Learned

1. **Payload Key Consistency**: Always verify key names match between serialization and deserialization
2. **Layer-by-Layer Testing**: Test at each layer (SDK → Republic → Tape → Storage) to isolate issues
3. **API Compatibility**: MiniMax supports OpenAI format better than documented
4. **Debugging Strategy**: Use monkey-patching to trace data flow through complex call chains
5. **Conversation Semantics**: LLM APIs are strict about message sequence completeness
6. **Method Intent**: Methods with similar names can have very different behaviors - document clearly
7. **Tape Recording**: Only record completed interactions; incomplete sequences break future calls

---

## Files Modified

### Bub Codebase
- `src/bub/integrations/republic_client.py` - MiniMax role conversion
- `src/bub/channels/wsbus.py` - Bus handler notification and exception handling
- `src/bub/channels/telegram.py` - Outbound message subscription
- `src/bub/rpc/protocol.py` - RPC cleanup, removed publishInbound/publishOutbound
- `src/bub/tape/context.py` - Anchor setting and tool_call_id handling
- `src/bub/tape/server.py` - Critical: tool_calls → calls key fix
- `src/bub/llm/format.py` - Standard message format definitions (new)
- `src/bub/llm/adapters.py` - Provider adapter framework (new)

### Republic Upstream
- `upstream/republic/src/republic/tape/manager.py` - Don't record empty tool_results
- `upstream/republic/src/republic/clients/chat.py` - Don't record incomplete tool call sequences

### Scripts
- `scripts/deploy-production.sh` - Production deployment script
- `scripts/test_bus_client.py` - Bus client test
- `scripts/test_minimax_tools.py` - Direct API test
- `scripts/test_minimax_format.py` - Format inspection
- `scripts/test_republic_minimax.py` - Republic integration test
- `scripts/test_bub_minimax_flow.py` - Full stack test
- `scripts/test_minimal_republic_minimax.py` - Minimal reproducible test
- `scripts/test_tape_tool_calls.py` - Tape recording debug
- `scripts/test_debug_messages.py` - Message reconstruction debug
- `scripts/test_bub_integration.py` - Integration tests

---

## Documentation Added

- `AGENTS.md` - Utility scripts documentation section
- `docs/journal/2026-02-16-minimax-integration-debugging.md` - This comprehensive journal entry

---

## Follow-up Actions

### Completed ✅
- Fixed critical tape server bug (tool_calls → calls key)
- Fixed empty tool_result recording
- Fixed incomplete tool call sequence recording
- Fixed bus handler notification
- Fixed bus exception handling
- Added Telegram outbound subscription
- Cleaned up RPC protocol
- Created comprehensive test scripts
- Verified all fixes with end-to-end tests

### TODO
- [ ] Add payload schema validation to tape server (catch key mismatches early)
- [ ] Add integration tests for tool call round-trip
- [ ] Document MiniMax compatibility in API docs
- [ ] Review other entry types for similar key mismatch issues
- [ ] Consider adding conversation sequence validation before sending to LLM
- [ ] Integrate provider adapters into Republic's API call layer
- [ ] Add validation before tape writes
- [ ] Add comprehensive adapter tests

---

## Related Documents

- `AGENTS.md` - Development workflow and utility scripts
- Test scripts in `scripts/` directory
- Upstream Republic code in `upstream/republic/`

---

## Consolidated from Previous Docs

This journal consolidates findings from:
- `docs/CHANGES-tool-call-debugging.md` - Architecture decisions and file changes
- `docs/debug-report-tool-calls.md` - Detailed bug analysis and proposed solutions  
- `docs/journal-2026-02-16.md` - Deployment and bus infrastructure changes
- `docs/tool-call-architecture-analysis.md` - Architecture analysis

**Note**: The smaller topic-specific documents have been merged into this comprehensive journal entry. Refer to this journal as the single source of truth for MiniMax integration debugging.
